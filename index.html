<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Dungeon Crawler</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#1a1a2e;touch-action:none;user-select:none;-webkit-user-select:none;font-family:'Segoe UI',system-ui,sans-serif}
canvas{display:block;width:100%;height:100%}
#ui-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
#health-bar-container{position:absolute;top:env(safe-area-inset-top,12px);left:50%;transform:translateX(-50%);width:55%;max-width:260px;pointer-events:none}
#level-label{color:#fbbf24;font-size:12px;font-weight:800;text-shadow:0 1px 3px rgba(0,0,0,0.8);text-align:center;margin-bottom:2px}
#health-bar-bg{width:100%;height:20px;background:rgba(0,0,0,0.6);border-radius:10px;border:2px solid rgba(255,255,255,0.3);overflow:hidden;position:relative}
#health-bar-fill{height:100%;background:linear-gradient(180deg,#4ade80,#22c55e);border-radius:8px;transition:width 0.3s;width:100%}
#health-text{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:10px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,0.8)}
#xp-bar-bg{width:100%;height:8px;background:rgba(0,0,0,0.5);border-radius:4px;overflow:hidden;margin-top:3px}
#xp-bar-fill{height:100%;background:linear-gradient(180deg,#a78bfa,#7c3aed);border-radius:4px;transition:width 0.3s;width:0%}
#gold-display{position:absolute;top:env(safe-area-inset-top,12px);left:12px;color:#fbbf24;font-size:14px;font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,0.8);pointer-events:none;margin-top:32px}
#bag-btn{position:absolute;top:env(safe-area-inset-top,12px);left:12px;width:40px;height:40px;background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;pointer-events:auto;cursor:pointer;-webkit-tap-highlight-color:transparent}
#stats-btn{position:absolute;top:env(safe-area-inset-top,12px);left:58px;width:40px;height:40px;background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;pointer-events:auto;cursor:pointer;-webkit-tap-highlight-color:transparent}
#depth-display{position:absolute;top:env(safe-area-inset-top,12px);right:100px;color:#94a3b8;font-size:11px;font-weight:600;text-shadow:0 1px 3px rgba(0,0,0,0.8);pointer-events:none}
#minimap{position:absolute;top:env(safe-area-inset-top,12px);right:12px;pointer-events:none;width:80px;height:80px}
#room-label{position:absolute;top:calc(env(safe-area-inset-top,12px) + 30px);left:50%;transform:translateX(-50%);color:#fff;font-size:13px;font-weight:600;text-shadow:0 1px 4px rgba(0,0,0,0.8);pointer-events:none;opacity:0;transition:opacity 0.5s}
#pickup-notifications{position:absolute;top:calc(env(safe-area-inset-top,12px) + 70px);left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:4px;pointer-events:none}
.pickup-note{color:#fff;font-size:13px;font-weight:700;text-shadow:0 1px 4px rgba(0,0,0,0.8);animation:pickupAnim 1.5s forwards;white-space:nowrap}
@keyframes pickupAnim{0%{opacity:1;transform:translateY(0)}70%{opacity:1}100%{opacity:0;transform:translateY(-20px)}}
#joystick-zone{position:absolute;bottom:20px;left:20px;width:140px;height:140px;pointer-events:auto}
#joystick-base{width:120px;height:120px;background:rgba(255,255,255,0.12);border:2px solid rgba(255,255,255,0.2);border-radius:50%;position:absolute;bottom:10px;left:10px}
#joystick-thumb{width:50px;height:50px;background:rgba(255,255,255,0.35);border:2px solid rgba(255,255,255,0.5);border-radius:50%;position:absolute;bottom:45px;left:45px;transition:none}
#ability-zone{position:absolute;bottom:30px;right:20px;display:flex;gap:14px;pointer-events:auto}
.ability-btn{width:64px;height:64px;border-radius:50%;border:3px solid rgba(255,255,255,0.4);display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;font-weight:700;position:relative;overflow:hidden;cursor:pointer;-webkit-tap-highlight-color:transparent}
.ability-btn .cd-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);clip-path:polygon(50% 50%,50% 0%,50% 0%);pointer-events:none}
.ability-btn .cd-text{position:absolute;font-size:16px;font-weight:800;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,0.8)}
#btn-attack{background:radial-gradient(circle,#ef4444,#b91c1c)}
#btn-dash{background:radial-gradient(circle,#3b82f6,#1d4ed8)}
#screen-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(0,0,0,0.85);z-index:100;pointer-events:auto}
#screen-overlay h1{color:#fbbf24;font-size:32px;text-shadow:0 2px 8px rgba(251,191,36,0.5);margin-bottom:8px}
#screen-overlay p{color:#e2e8f0;font-size:16px;margin-bottom:24px}
#screen-overlay button{padding:14px 40px;font-size:18px;font-weight:700;border:none;border-radius:12px;background:linear-gradient(180deg,#fbbf24,#f59e0b);color:#1a1a2e;cursor:pointer;box-shadow:0 4px 12px rgba(251,191,36,0.4)}
#start-screen{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;flex-direction:column;background:linear-gradient(180deg,#1a1a2e,#16213e);z-index:200;pointer-events:auto}
#start-screen h1{color:#fbbf24;font-size:36px;text-shadow:0 2px 12px rgba(251,191,36,0.5);margin-bottom:6px;letter-spacing:2px}
#start-screen p{color:#94a3b8;font-size:14px;margin-bottom:30px}
#start-screen button{padding:16px 48px;font-size:20px;font-weight:800;border:none;border-radius:14px;background:linear-gradient(180deg,#fbbf24,#f59e0b);color:#1a1a2e;cursor:pointer;box-shadow:0 4px 16px rgba(251,191,36,0.4);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
#death-screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;background:rgba(127,29,29,0.85);z-index:100;pointer-events:auto}
#death-screen h1{color:#fca5a5;font-size:32px;margin-bottom:8px}
#death-screen p{color:#e2e8f0;font-size:16px;margin-bottom:24px}
#death-screen button{padding:14px 40px;font-size:18px;font-weight:700;border:none;border-radius:12px;background:linear-gradient(180deg,#ef4444,#dc2626);color:#fff;cursor:pointer}

/* Hub screen */
#hub-screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:flex-start;background:linear-gradient(180deg,#1a1a2e,#16213e);z-index:150;pointer-events:auto;overflow-y:auto;padding:40px 20px 40px}
#hub-screen .hub-title{color:#94a3b8;font-size:12px;text-transform:uppercase;letter-spacing:3px;margin-bottom:8px}
#hub-hero-name{color:#fbbf24;font-size:28px;font-weight:800;text-shadow:0 2px 8px rgba(251,191,36,0.5);margin-bottom:2px}
#hub-hero-level{color:#a78bfa;font-size:14px;margin-bottom:16px}
#hub-character-canvas{width:160px;height:160px;border-radius:50%;margin-bottom:16px}
#hub-stats-row{display:flex;gap:16px;margin-bottom:12px}
.hub-stat-box{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:8px 14px;text-align:center;min-width:70px}
.hub-stat-box .stat-val{color:#fbbf24;font-size:18px;font-weight:800}
.hub-stat-box .stat-label{color:#94a3b8;font-size:10px;text-transform:uppercase;letter-spacing:1px}
#hub-info{color:#94a3b8;font-size:13px;text-align:center;margin-bottom:16px;line-height:1.8}
#hub-info span{color:#fbbf24}
#hub-gear-slots{display:flex;gap:10px;margin-bottom:20px}
.hub-gear-slot{width:64px;height:64px;background:rgba(255,255,255,0.06);border:2px solid rgba(255,255,255,0.15);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#94a3b8;text-align:center}
.hub-gear-slot .item-icon{font-size:24px;margin-bottom:2px}
.hub-gear-slot .item-name{font-size:8px;line-height:1.1;color:#fff}
#hub-buttons{display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;align-items:center}
#hub-buttons button{width:100%;padding:14px;font-size:18px;font-weight:800;border:none;border-radius:14px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,0.3)}
#btn-enter-dungeon{background:linear-gradient(180deg,#fbbf24,#f59e0b);color:#1a1a2e;animation:pulse 2s infinite}
#btn-hub-inventory{background:rgba(255,255,255,0.1);color:#e2e8f0;border:2px solid rgba(255,255,255,0.2)!important;font-size:15px!important}

/* Stats panel */
#stats-panel{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;background:rgba(0,0,0,0.94);z-index:180;pointer-events:auto;overflow-y:auto;padding:50px 20px 30px}
#stats-panel h2{color:#fbbf24;font-size:22px;margin-bottom:16px}
#stats-close{position:absolute;top:16px;right:16px;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
.stats-section{width:100%;max-width:340px;margin-bottom:18px}
.stats-section h3{color:#94a3b8;font-size:11px;text-transform:uppercase;margin-bottom:8px;letter-spacing:1px;border-bottom:1px solid rgba(255,255,255,0.08);padding-bottom:4px}
.stat-row{display:flex;justify-content:space-between;padding:5px 0;color:#e2e8f0;font-size:14px}
.stat-row .stat-name{color:#94a3b8}
.stat-row .stat-value{color:#fff;font-weight:700}
.stat-row .stat-bonus{color:#22c55e;font-size:12px;margin-left:4px}
.stat-row .stat-base{color:#94a3b8;font-size:12px}

/* Inventory panel */
#inventory-panel{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;background:rgba(0,0,0,0.92);z-index:180;pointer-events:auto;overflow-y:auto;padding:50px 16px 30px}
#inventory-panel h2{color:#fbbf24;font-size:22px;margin-bottom:12px}
#inv-close{position:absolute;top:16px;right:16px;color:#fff;font-size:28px;cursor:pointer;width:40px;height:40px;display:flex;align-items:center;justify-content:center}
.inv-section{width:100%;max-width:360px;margin-bottom:16px}
.inv-section h3{color:#94a3b8;font-size:12px;text-transform:uppercase;margin-bottom:6px;letter-spacing:1px}
.inv-slots{display:flex;flex-wrap:wrap;gap:8px}
.inv-slot{width:72px;height:72px;background:rgba(255,255,255,0.08);border:2px solid rgba(255,255,255,0.15);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:10px;color:#fff;cursor:pointer;position:relative;text-align:center;padding:2px}
.inv-slot.empty{opacity:0.4}
.inv-slot .item-icon{font-size:22px;margin-bottom:2px}
.inv-slot .item-name{font-size:8px;line-height:1.1}
.rarity-common{border-color:rgba(255,255,255,0.4)}
.rarity-uncommon{border-color:#22c55e}
.rarity-rare{border-color:#3b82f6}
.rarity-epic{border-color:#a855f7}
.rarity-legendary{border-color:#f97316}

/* Level up overlay */
#levelup-overlay{position:absolute;top:0;left:0;width:100%;height:100%;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:90;pointer-events:none}
#levelup-flash{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle,rgba(251,191,36,0.6),rgba(251,191,36,0));opacity:0;transition:opacity 0.2s}
#levelup-text{color:#fbbf24;font-size:48px;font-weight:900;text-shadow:0 0 30px rgba(251,191,36,0.8),0 0 60px rgba(251,191,36,0.4);opacity:0;transform:scale(0.3);letter-spacing:4px}
#levelup-stats{color:#e2e8f0;font-size:16px;font-weight:700;text-shadow:0 2px 8px rgba(0,0,0,0.8);opacity:0;margin-top:12px;text-align:center;line-height:1.8}
@keyframes levelupScale{0%{transform:scale(0.3);opacity:0}20%{transform:scale(1.3);opacity:1}40%{transform:scale(1);opacity:1}80%{transform:scale(1);opacity:1}100%{transform:scale(1.1);opacity:0}}
@keyframes levelupStatsFade{0%{opacity:0;transform:translateY(20px)}20%{opacity:1;transform:translateY(0)}80%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui-overlay">
  <div id="health-bar-container">
    <div id="level-label">Lv 1</div>
    <div id="health-bar-bg"><div id="health-bar-fill"></div><div id="health-text">100 / 100</div></div>
    <div id="xp-bar-bg"><div id="xp-bar-fill"></div></div>
  </div>
  <div id="bag-btn">üéí</div>
  <div id="stats-btn">üìä</div>
  <div id="gold-display">üí∞ 0</div>
  <div id="depth-display"></div>
  <canvas id="minimap" width="80" height="80"></canvas>
  <div id="room-label"></div>
  <div id="pickup-notifications"></div>
  <div id="levelup-overlay">
    <div id="levelup-flash"></div>
    <div id="levelup-text">LEVEL UP!</div>
    <div id="levelup-stats"></div>
  </div>
  <div id="joystick-zone"><div id="joystick-base"></div><div id="joystick-thumb"></div></div>
  <div id="ability-zone">
    <div class="ability-btn" id="btn-attack"><span>‚öî</span><div class="cd-overlay"></div><span class="cd-text"></span></div>
    <div class="ability-btn" id="btn-dash"><span>üí®</span><div class="cd-overlay"></div><span class="cd-text"></span></div>
  </div>
</div>
<div id="start-screen"><h1>‚öî DUNGEON CRAWLER</h1><p>Casual Dungeon Crawling</p><button id="btn-start">TAP TO PLAY</button></div>
<div id="screen-overlay"><h1>üèÜ DUNGEON COMPLETE!</h1><p id="complete-text">You conquered the dungeon!</p><button id="btn-restart">RETURN TO HUB</button></div>
<div id="death-screen"><h1>üíÄ YOU DIED</h1><p>The dungeon claims another soul...</p><button id="btn-retry">RETURN TO HUB</button></div>
<div id="hub-screen">
  <div class="hub-title">ADVENTURER'S HUB</div>
  <canvas id="hub-character-canvas" width="160" height="160"></canvas>
  <div id="hub-hero-name">Hero</div>
  <div id="hub-hero-level">Level 1</div>
  <div id="hub-stats-row">
    <div class="hub-stat-box"><div class="stat-val" id="hub-atk">25</div><div class="stat-label">ATK</div></div>
    <div class="hub-stat-box"><div class="stat-val" id="hub-def">0</div><div class="stat-label">DEF</div></div>
    <div class="hub-stat-box"><div class="stat-val" id="hub-hp">100</div><div class="stat-label">HP</div></div>
  </div>
  <div id="hub-info"></div>
  <div id="hub-gear-slots"></div>
  <div id="hub-buttons">
    <button id="btn-enter-dungeon">‚öî ENTER DUNGEON</button>
    <button id="btn-hub-inventory">üéí INVENTORY</button>
  </div>
</div>
<div id="inventory-panel">
  <div id="inv-close">‚úï</div>
  <h2>üéí Inventory</h2>
  <div class="inv-section"><h3>Equipped</h3><div class="inv-slots" id="equipped-slots"></div></div>
  <div class="inv-section"><h3>Backpack</h3><div class="inv-slots" id="backpack-slots"></div></div>
</div>
<div id="stats-panel">
  <div id="stats-close">‚úï</div>
  <h2>üìä Stats</h2>
  <div id="stats-content"></div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ
let TILE = 36;
const PLAYER_R = 14;
const CAM_SMOOTH = 0.08;

// ‚îÄ‚îÄ‚îÄ HAPTICS ‚îÄ‚îÄ‚îÄ
function haptic(type){
  try{
    if(navigator.vibrate){
      switch(type){
        case'light':navigator.vibrate(10);break;
        case'medium':navigator.vibrate(25);break;
        case'heavy':navigator.vibrate(50);break;
        case'kill':navigator.vibrate([20,30,40]);break;
        case'die':navigator.vibrate([50,30,50,30,100]);break;
        case'win':navigator.vibrate([30,50,30,50,30,50,100]);break;
      }
    }
  }catch(e){}
}

// ‚îÄ‚îÄ‚îÄ SFX (Web Audio API) ‚îÄ‚îÄ‚îÄ
let audioCtx;
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function sfx(type){
  initAudio();if(!audioCtx)return;
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  const t=audioCtx.currentTime;
  switch(type){
    case'hit':
      o.type='square';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(80,t+0.1);
      g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);
      o.start(t);o.stop(t+0.1);break;
    case'kill':
      o.type='square';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(800,t+0.1);
      g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);
      o.start(t);o.stop(t+0.15);break;
    case'attack':
      o.type='sawtooth';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(100,t+0.08);
      g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.08);
      o.start(t);o.stop(t+0.08);break;
    case'dash':
      o.type='sine';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(600,t+0.15);
      g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);
      o.start(t);o.stop(t+0.15);break;
    case'hurt':
      o.type='sawtooth';o.frequency.setValueAtTime(150,t);o.frequency.exponentialRampToValueAtTime(50,t+0.2);
      g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.2);
      o.start(t);o.stop(t+0.2);break;
    case'door':
      o.type='sine';o.frequency.setValueAtTime(400,t);o.frequency.exponentialRampToValueAtTime(600,t+0.1);
      g.gain.setValueAtTime(0.2,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.3);
      o.start(t);o.stop(t+0.3);
      const o2=audioCtx.createOscillator(),g2=audioCtx.createGain();
      o2.connect(g2);g2.connect(audioCtx.destination);
      o2.type='sine';o2.frequency.setValueAtTime(600,t+0.1);o2.frequency.exponentialRampToValueAtTime(800,t+0.2);
      g2.gain.setValueAtTime(0.2,t+0.1);g2.gain.exponentialRampToValueAtTime(0.01,t+0.3);
      o2.start(t+0.1);o2.stop(t+0.3);break;
    case'win':
      [400,500,600,800].forEach((f,i)=>{
        const ow=audioCtx.createOscillator(),gw=audioCtx.createGain();
        ow.connect(gw);gw.connect(audioCtx.destination);
        ow.type='sine';ow.frequency.setValueAtTime(f,t+i*0.15);
        gw.gain.setValueAtTime(0.2,t+i*0.15);gw.gain.exponentialRampToValueAtTime(0.01,t+i*0.15+0.3);
        ow.start(t+i*0.15);ow.stop(t+i*0.15+0.3);
      });break;
    case'die':
      o.type='sawtooth';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(30,t+0.5);
      g.gain.setValueAtTime(0.3,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.5);
      o.start(t);o.stop(t+0.5);break;
    case'pickup':
      o.type='sine';o.frequency.setValueAtTime(600,t);o.frequency.exponentialRampToValueAtTime(900,t+0.1);
      g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.15);
      o.start(t);o.stop(t+0.15);break;
    case'levelup':
      [500,600,700,800,1000].forEach((f,i)=>{
        const ol=audioCtx.createOscillator(),gl=audioCtx.createGain();
        ol.connect(gl);gl.connect(audioCtx.destination);
        ol.type='sine';ol.frequency.setValueAtTime(f,t+i*0.1);
        gl.gain.setValueAtTime(0.2,t+i*0.1);gl.gain.exponentialRampToValueAtTime(0.01,t+i*0.1+0.2);
        ol.start(t+i*0.1);ol.stop(t+i*0.1+0.2);
      });break;
    case'charge_impact':
      o.type='sawtooth';o.frequency.setValueAtTime(80,t);o.frequency.exponentialRampToValueAtTime(30,t+0.2);
      g.gain.setValueAtTime(0.4,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.25);
      o.start(t);o.stop(t+0.25);break;
    case'explosion':
      o.type='sawtooth';o.frequency.setValueAtTime(120,t);o.frequency.exponentialRampToValueAtTime(20,t+0.4);
      g.gain.setValueAtTime(0.5,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);
      o.start(t);o.stop(t+0.4);
      {const o3=audioCtx.createOscillator(),g3=audioCtx.createGain();
      o3.connect(g3);g3.connect(audioCtx.destination);
      o3.type='square';o3.frequency.setValueAtTime(60,t);o3.frequency.exponentialRampToValueAtTime(15,t+0.3);
      g3.gain.setValueAtTime(0.3,t);g3.gain.exponentialRampToValueAtTime(0.01,t+0.35);
      o3.start(t);o3.stop(t+0.35);}break;
    case'summon':
      o.type='sine';o.frequency.setValueAtTime(200,t);o.frequency.exponentialRampToValueAtTime(500,t+0.3);
      g.gain.setValueAtTime(0.15,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.4);
      o.start(t);o.stop(t+0.4);
      {const o4=audioCtx.createOscillator(),g4=audioCtx.createGain();
      o4.connect(g4);g4.connect(audioCtx.destination);
      o4.type='sine';o4.frequency.setValueAtTime(350,t+0.1);o4.frequency.exponentialRampToValueAtTime(700,t+0.35);
      g4.gain.setValueAtTime(0.12,t+0.1);g4.gain.exponentialRampToValueAtTime(0.01,t+0.4);
      o4.start(t+0.1);o4.stop(t+0.4);}break;
    case'shield_block':
      o.type='square';o.frequency.setValueAtTime(300,t);o.frequency.exponentialRampToValueAtTime(150,t+0.08);
      g.gain.setValueAtTime(0.25,t);g.gain.exponentialRampToValueAtTime(0.01,t+0.1);
      o.start(t);o.stop(t+0.1);break;
  }
}
const ATTACK_RANGE = 50;
const BASE_ATTACK_DMG = 25;
const ATTACK_CD = 0.6;
const DASH_DIST = 120;
const DASH_CD = 3;
const DASH_DUR = 0.15;

// ‚îÄ‚îÄ‚îÄ GEAR SYSTEM ‚îÄ‚îÄ‚îÄ
const RARITIES = [
  {name:'common',color:'#ffffff',weight:50,statBonus:1},
  {name:'uncommon',color:'#22c55e',weight:30,statBonus:1.5},
  {name:'rare',color:'#3b82f6',weight:13,statBonus:2.5},
  {name:'epic',color:'#a855f7',weight:5,statBonus:4},
  {name:'legendary',color:'#f97316',weight:2,statBonus:6}
];
const GEAR_MATERIALS=['Rusty','Iron','Steel','Silver','Crystal','Shadow','Golden','Ancient','Dragon','Void'];
const GEAR_TYPES={
  weapon:[{name:'Sword',icon:'‚öîÔ∏è'},{name:'Axe',icon:'ü™ì'},{name:'Dagger',icon:'üó°Ô∏è'},{name:'Staff',icon:'ü™Ñ'},{name:'Hammer',icon:'üî®'}],
  armor:[{name:'Shield',icon:'üõ°Ô∏è'},{name:'Chestplate',icon:'ü¶∫'},{name:'Helm',icon:'‚õëÔ∏è'},{name:'Robe',icon:'üëò'}],
  accessory:[{name:'Ring',icon:'üíç'},{name:'Amulet',icon:'üìø'},{name:'Charm',icon:'üîÆ'},{name:'Cape',icon:'üß£'}]
};
const STAT_TYPES=['ATK','DEF','HP','Speed'];

function pickRarity(depth){
  let weights=RARITIES.map((r,i)=>r.weight*(i>=2?1+depth*0.1:1));
  let total=weights.reduce((a,b)=>a+b,0);
  let roll=Math.random()*total;
  for(let i=0;i<RARITIES.length;i++){roll-=weights[i];if(roll<=0)return RARITIES[i];}
  return RARITIES[0];
}

function generateGear(slot,depth){
  const rarity=pickRarity(depth||1);
  const types=GEAR_TYPES[slot];
  const type=types[Math.floor(Math.random()*types.length)];
  const mat=GEAR_MATERIALS[Math.min(Math.floor(Math.random()*(3+depth)),GEAR_MATERIALS.length-1)];
  const numStats=Math.random()<0.5?1:2;
  const stats={};
  const usedStats=[];
  for(let i=0;i<numStats;i++){
    let st;
    do{st=STAT_TYPES[Math.floor(Math.random()*STAT_TYPES.length)];}while(usedStats.includes(st));
    usedStats.push(st);
    const base=st==='HP'?Math.floor(5+Math.random()*10):Math.floor(1+Math.random()*4);
    stats[st]=Math.ceil(base*rarity.statBonus);
  }
  return{slot,name:mat+' '+type.name,icon:type.icon,rarity:rarity.name,rarityColor:rarity.color,stats,id:Math.random().toString(36).substr(2,9)};
}

// ‚îÄ‚îÄ‚îÄ PERSISTENT STATE ‚îÄ‚îÄ‚îÄ
let gold=0,dungeonDepth=1;
let playerLevel=1,playerXP=0;
let baseMaxHp=100,baseAtk=0,baseDef=0,baseSpeed=0;
let equipped={weapon:null,armor:null,accessory:null};
let backpack=[]; // max 12

// ‚îÄ‚îÄ‚îÄ LIFETIME STATS ‚îÄ‚îÄ‚îÄ
let lifetimeKills=0, lifetimeDungeons=0, lifetimeGold=0;

// ‚îÄ‚îÄ‚îÄ SLOW-MO FOR LEVEL UP ‚îÄ‚îÄ‚îÄ
let slowMoTimer=0;
let levelUpAnimTimer=0;

function xpToLevel(lv){return lv*50;}

function getGearStats(){
  let s={ATK:0,DEF:0,HP:0,Speed:0};
  for(let sl in equipped){if(equipped[sl]){for(let st in equipped[sl].stats)s[st]+=equipped[sl].stats[st];}}
  return s;
}

function totalAtk(){return BASE_ATTACK_DMG+baseAtk+getGearStats().ATK;}
function totalDef(){return baseDef+getGearStats().DEF;}
function totalMaxHp(){return baseMaxHp+getGearStats().HP;}
function totalSpeed(){return 160+baseSpeed+getGearStats().Speed*10;}

// ‚îÄ‚îÄ‚îÄ PLAYER VISUAL PROGRESSION ‚îÄ‚îÄ‚îÄ
function getPlayerColor(){
  if(playerLevel>=10) return {main:'#fbbf24',mid:'#d97706',light:'#fde68a'}; // gold
  if(playerLevel>=7) return {main:'#a855f7',mid:'#7e22ce',light:'#c4b5fd'}; // purple
  if(playerLevel>=4) return {main:'#22c55e',mid:'#16a34a',light:'#86efac'}; // green
  return {main:'#3b82f6',mid:'#2563eb',light:'#93c5fd'}; // blue
}

function getPlayerRadius(){
  return PLAYER_R + Math.min(playerLevel-1,12)*0.5; // +0.5 per level, capped at +6
}

function getGlowIntensity(){
  return Math.min(playerLevel/10, 1.0); // 0.1 at lv1, 1.0 at lv10+
}

function getAttackRange(){
  return ATTACK_RANGE + (playerLevel-1)*2; // slightly bigger slash per level
}

function getDashDist(){
  return DASH_DIST + (playerLevel-1)*5; // slightly more dash per level
}

function hasFullGear(){
  return equipped.weapon && equipped.armor && equipped.accessory;
}

// ‚îÄ‚îÄ‚îÄ SPARKLE PARTICLES (full gear set) ‚îÄ‚îÄ‚îÄ
let sparkleTimer=0;
let sparkleParticles=[];

function gainXP(amount){
  playerXP+=amount;
  let needed=xpToLevel(playerLevel);
  while(playerXP>=needed){
    playerXP-=needed;
    playerLevel++;
    baseMaxHp+=10;baseAtk+=2;baseDef+=1;
    player.maxHp=totalMaxHp();
    player.hp=player.maxHp;
    sfx('levelup');haptic('win');
    
    // Level up overlay animation
    triggerLevelUpOverlay();
    
    // Slow-mo for 3 seconds
    slowMoTimer=3.0;
    
    showPickup('LEVEL UP! Lv '+playerLevel,'#fbbf24');
    // golden particles
    for(let i=0;i<20;i++){
      const a=Math.random()*Math.PI*2,sp=60+Math.random()*120;
      particles.push({x:player.x,y:player.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:1,maxLife:1,r:3+Math.random()*4,color:'#fbbf24'});
    }
    needed=xpToLevel(playerLevel);
  }
}

function triggerLevelUpOverlay(){
  const overlay=document.getElementById('levelup-overlay');
  const flash=document.getElementById('levelup-flash');
  const text=document.getElementById('levelup-text');
  const stats=document.getElementById('levelup-stats');
  
  overlay.style.display='flex';
  flash.style.opacity='1';
  text.style.animation='none';
  stats.style.animation='none';
  
  // Force reflow
  void text.offsetWidth;
  
  text.style.animation='levelupScale 3s forwards';
  stats.innerHTML=`+10 HP &nbsp; +2 ATK &nbsp; +1 DEF`;
  stats.style.animation='levelupStatsFade 3s forwards';
  
  setTimeout(()=>{flash.style.opacity='0';},300);
  setTimeout(()=>{overlay.style.display='none';text.style.animation='none';stats.style.animation='none';},3000);
}

// ‚îÄ‚îÄ‚îÄ LOOT DROPS ‚îÄ‚îÄ‚îÄ
let lootDrops=[];

function spawnLoot(x,y,enemyType){
  const isBoss=enemyType==='boss';
  const goldAmt=isBoss?50+Math.floor(Math.random()*50):5+Math.floor(Math.random()*15);
  lootDrops.push({x:x+(Math.random()-0.5)*20,y:y+(Math.random()-0.5)*20,type:'gold',amount:goldAmt,glow:0,icon:'üí∞'});
  const gearChance=isBoss?1:0.3;
  if(Math.random()<gearChance){
    const slots=['weapon','armor','accessory'];
    const slot=slots[Math.floor(Math.random()*slots.length)];
    const gear=generateGear(slot,dungeonDepth);
    lootDrops.push({x:x+(Math.random()-0.5)*30,y:y+(Math.random()-0.5)*30,type:'gear',gear,glow:0,icon:gear.icon});
  }
}

function showPickup(text,color){
  const el=document.createElement('div');
  el.className='pickup-note';
  el.textContent=text;
  el.style.color=color||'#fff';
  document.getElementById('pickup-notifications').appendChild(el);
  setTimeout(()=>el.remove(),1500);
}

// ‚îÄ‚îÄ‚îÄ ROOMS ‚îÄ‚îÄ‚îÄ
const ROOM_W = 15, ROOM_H = 21;
function makeRoom(){
  const r=[];
  for(let y=0;y<ROOM_H;y++){const row=[];for(let x=0;x<ROOM_W;x++){
    if(y===0||y===ROOM_H-1||x===0||x===ROOM_W-1)row.push(1);else row.push(0);
  }r.push(row)}return r;
}
function addDoor(r,side){
  if(side==='top'){r[0][7]=2;}
  if(side==='bottom'){r[ROOM_H-1][7]=2;}
}

// ‚îÄ‚îÄ‚îÄ RANDOM DUNGEON GENERATION ‚îÄ‚îÄ‚îÄ
let dungeonRooms=[];

function generateDungeon(depth){
  const numRooms=5+Math.floor(Math.random()*4);
  const defs=[];
  for(let i=0;i<numRooms;i++){
    const isBoss=i===numRooms-1;
    const isFirst=i===0;
    const doors=[];
    if(!isFirst)doors.push('top');
    if(!isBoss)doors.push('bottom');

    let enList=[];
    // Build enemy pool based on depth
    let pool=['slime'];
    if(depth>=1) pool.push('wolf');
    if(depth>=2) pool.push('archer');
    if(depth>=3) pool.push('charger','bomber','skeleton');
    if(depth>=5) pool.push('necromancer','shield_knight');

    if(isBoss){
      enList.push({type:'boss',x:7,y:8});
      // Boss rooms spawn 1-2 minions
      const minionCount=1+Math.floor(Math.random()*2);
      for(let m=0;m<minionCount;m++){
        const mt=pool[Math.floor(Math.random()*pool.length)];
        if(mt==='wolf'){
          enList.push({type:'pack',count:3,x:3+m*8,y:12});
        }else{
          enList.push({type:mt,x:3+m*8,y:12});
        }
      }
    }else{
      const numEnemies=2+Math.floor(Math.random()*3)+Math.floor(depth*0.5);
      let spawned=0;
      while(spawned<numEnemies){
        const type=pool[Math.floor(Math.random()*pool.length)];
        const ex=2+Math.floor(Math.random()*11);
        const ey=3+Math.floor(Math.random()*14);
        if(type==='wolf'){
          const count=3+Math.floor(Math.random()*2); // 3-4
          enList.push({type:'pack',count,x:ex,y:ey});
          spawned+=count;
        }else{
          enList.push({type,x:ex,y:ey});
          spawned++;
        }
      }
    }

    const roomNames=isBoss?'üî• BOSS ARENA üî•':['Dark Hall','Ancient Chamber','Dusty Corridor','Treasure Room','Cursed Vault','Forgotten Crypt','Spider Den','Mossy Cave'][i%8];
    defs.push({name:roomNames,enemies:enList,doors,isBoss});
  }
  return defs;
}

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ
let canvas,ctx,W,H,minimapCtx;
let gameStarted=false, gameOver=false, gameDead=false, inHub=false;
let player,camera,rooms,currentRoom,particles,dmgNumbers,enemies;
let joystickActive=false,joystickTouchId=null,joyVec={x:0,y:0};
let abilities={attack:{cd:0,maxCd:ATTACK_CD},dash:{cd:0,maxCd:DASH_CD}};
let shakeTimer=0,shakeIntensity=0;
let roomTransition=0,roomTransAlpha=0;
let lastTime=0;

// ‚îÄ‚îÄ‚îÄ HUB AMBIENT PARTICLES ‚îÄ‚îÄ‚îÄ
let hubParticles=[];
let hubAnimFrame=null;

function startHubAmbient(){
  const hc=document.getElementById('hub-character-canvas');
  const hctx=hc.getContext('2d');
  hubParticles=[];
  for(let i=0;i<30;i++){
    hubParticles.push({
      x:Math.random()*160,y:Math.random()*160,
      vx:(Math.random()-0.5)*0.3,vy:-0.2-Math.random()*0.3,
      r:1+Math.random()*2,alpha:Math.random(),
      color:['#fbbf24','#a78bfa','#60a5fa','#fff'][Math.floor(Math.random()*4)]
    });
  }
  function drawHubChar(){
    hctx.clearRect(0,0,160,160);
    
    // Ambient particles
    hubParticles.forEach(p=>{
      p.x+=p.vx;p.y+=p.vy;
      p.alpha+=Math.sin(Date.now()*0.003+p.x)*0.01;
      if(p.y<-5){p.y=165;p.x=Math.random()*160;}
      if(p.x<-5||p.x>165){p.x=Math.random()*160;}
      hctx.globalAlpha=Math.max(0,Math.min(1,p.alpha*0.4));
      hctx.fillStyle=p.color;
      hctx.beginPath();hctx.arc(p.x,p.y,p.r,0,Math.PI*2);hctx.fill();
    });
    hctx.globalAlpha=1;
    
    const cx=80,cy=80;
    const colors=getPlayerColor();
    const pr=getPlayerRadius()*2; // bigger for hub display
    const glowI=getGlowIntensity();
    
    // Glow ring
    if(glowI>0.05){
      const gradient=hctx.createRadialGradient(cx,cy,pr,cx,cy,pr+15+glowI*10);
      gradient.addColorStop(0,`rgba(251,191,36,${glowI*0.5})`);
      gradient.addColorStop(1,'rgba(251,191,36,0)');
      hctx.fillStyle=gradient;
      hctx.beginPath();hctx.arc(cx,cy,pr+15+glowI*10,0,Math.PI*2);hctx.fill();
    }
    
    // Shadow
    hctx.fillStyle='rgba(0,0,0,0.3)';
    hctx.beginPath();hctx.ellipse(cx,cy+pr+4,pr,pr*0.3,0,0,Math.PI*2);hctx.fill();
    
    // Body
    hctx.fillStyle=colors.main;
    hctx.beginPath();hctx.arc(cx,cy,pr,0,Math.PI*2);hctx.fill();
    hctx.fillStyle=colors.mid;
    hctx.beginPath();hctx.arc(cx,cy+2,pr-3,0,Math.PI*2);hctx.fill();
    hctx.fillStyle=colors.main;
    hctx.beginPath();hctx.arc(cx,cy-1,pr-5,0,Math.PI*2);hctx.fill();
    
    // Eyes
    hctx.fillStyle='#fff';
    hctx.beginPath();hctx.arc(cx-6,cy-3,5,0,Math.PI*2);hctx.fill();
    hctx.beginPath();hctx.arc(cx+6,cy-3,5,0,Math.PI*2);hctx.fill();
    hctx.fillStyle='#1e293b';
    hctx.beginPath();hctx.arc(cx-5,cy-3,2.5,0,Math.PI*2);hctx.fill();
    hctx.beginPath();hctx.arc(cx+7,cy-3,2.5,0,Math.PI*2);hctx.fill();
    
    // Equipped gear icons floating around
    const gearIcons=[];
    if(equipped.weapon) gearIcons.push(equipped.weapon.icon);
    if(equipped.armor) gearIcons.push(equipped.armor.icon);
    if(equipped.accessory) gearIcons.push(equipped.accessory.icon);
    gearIcons.forEach((icon,i)=>{
      const angle=-Math.PI/2+i*(Math.PI*2/3)+Date.now()*0.001;
      const gx=cx+Math.cos(angle)*(pr+18);
      const gy=cy+Math.sin(angle)*(pr+18);
      hctx.font='16px system-ui';hctx.textAlign='center';hctx.textBaseline='middle';
      hctx.fillText(icon,gx,gy);
    });
    
    // Full gear sparkle
    if(hasFullGear()){
      for(let i=0;i<3;i++){
        const sa=Date.now()*0.002+i*2.1;
        const sx=cx+Math.cos(sa)*(pr+8+Math.sin(Date.now()*0.005+i)*5);
        const sy=cy+Math.sin(sa)*(pr+8+Math.cos(Date.now()*0.004+i)*5);
        hctx.globalAlpha=0.5+Math.sin(Date.now()*0.008+i)*0.3;
        hctx.fillStyle='#fbbf24';
        hctx.beginPath();hctx.arc(sx,sy,1.5,0,Math.PI*2);hctx.fill();
      }
      hctx.globalAlpha=1;
    }
    
    hubAnimFrame=requestAnimationFrame(drawHubChar);
  }
  drawHubChar();
}

function stopHubAmbient(){
  if(hubAnimFrame){cancelAnimationFrame(hubAnimFrame);hubAnimFrame=null;}
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
function init(){
  canvas=document.getElementById('game');
  ctx=canvas.getContext('2d');
  minimapCtx=document.getElementById('minimap').getContext('2d');
  resize();
  window.addEventListener('resize',resize);
  setupTouch();
  document.getElementById('btn-start').addEventListener('click',startGame);
  document.getElementById('btn-restart').addEventListener('click',()=>{document.getElementById('screen-overlay').style.display='none';showHub();});
  document.getElementById('btn-retry').addEventListener('click',()=>{document.getElementById('death-screen').style.display='none';showHub();});
  document.getElementById('btn-attack').addEventListener('touchstart',e=>{e.preventDefault();doAttack();});
  document.getElementById('btn-attack').addEventListener('click',doAttack);
  document.getElementById('btn-dash').addEventListener('touchstart',e=>{e.preventDefault();doDash();});
  document.getElementById('btn-dash').addEventListener('click',doDash);
  document.getElementById('btn-enter-dungeon').addEventListener('click',enterDungeon);
  document.getElementById('bag-btn').addEventListener('click',openInventory);
  document.getElementById('stats-btn').addEventListener('click',openStats);
  document.getElementById('inv-close').addEventListener('click',closeInventory);
  document.getElementById('stats-close').addEventListener('click',closeStats);
  document.getElementById('btn-hub-inventory').addEventListener('click',openInventory);
  requestAnimationFrame(loop);
}

let gameScale=1;
function resize(){
  const dpr=window.devicePixelRatio||1;
  W=window.innerWidth;H=window.innerHeight;
  TILE=Math.ceil(W/(ROOM_W*0.55));
  canvas.width=W*dpr;canvas.height=H*dpr;
  gameScale=1;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

function showHub(){
  inHub=true;gameStarted=false;gameOver=false;gameDead=false;
  
  document.getElementById('hub-hero-level').textContent='Level '+playerLevel;
  document.getElementById('hub-atk').textContent=totalAtk();
  document.getElementById('hub-def').textContent=totalDef();
  document.getElementById('hub-hp').textContent=totalMaxHp();
  
  let info=`üí∞ <span>${gold}</span> Gold &nbsp;¬∑&nbsp; Dungeon Depth: <span>${dungeonDepth}</span>`;
  document.getElementById('hub-info').innerHTML=info;
  
  // Gear slots
  const gearDiv=document.getElementById('hub-gear-slots');
  gearDiv.innerHTML='';
  ['weapon','armor','accessory'].forEach(slot=>{
    const item=equipped[slot];
    const el=document.createElement('div');
    el.className='hub-gear-slot';
    if(item){
      el.style.borderColor=item.rarityColor;
      el.innerHTML=`<div class="item-icon">${item.icon}</div><div class="item-name" style="color:${item.rarityColor}">${item.name}</div>`;
    }else{
      el.innerHTML=`<div class="item-icon" style="opacity:0.3">‚Äî</div><div class="item-name">${slot}</div>`;
    }
    gearDiv.appendChild(el);
  });
  
  document.getElementById('hub-screen').style.display='flex';
  startHubAmbient();
}

function enterDungeon(){
  stopHubAmbient();
  document.getElementById('hub-screen').style.display='none';
  inHub=false;
  resetGame();
}

function resetGame(){
  player={x:7*TILE+TILE/2,y:17*TILE+TILE/2,hp:totalMaxHp(),maxHp:totalMaxHp(),r:PLAYER_R,vx:0,vy:0,speed:totalSpeed(),facing:{x:0,y:-1},dashing:false,dashTimer:0,dashDir:{x:0,y:0},invincible:0,attackAnim:0};
  camera={x:0,y:0};
  currentRoom=0;
  particles=[];
  dmgNumbers=[];
  enemies=[];
  lootDrops=[];
  projectiles=[];
  sparkleParticles=[];
  abilities.attack.cd=0;abilities.dash.cd=0;
  gameOver=false;gameDead=false;
  slowMoTimer=0;
  dungeonRooms=generateDungeon(dungeonDepth);
  rooms=dungeonRooms.map(d=>{const m=makeRoom();d.doors.forEach(s=>addDoor(m,s));return m;});
  spawnEnemies();
  showRoomLabel(dungeonRooms[0].name);
  document.getElementById('depth-display').textContent='Run '+dungeonDepth;
  gameStarted=true;
}

function startGame(){
  initAudio();
  document.getElementById('start-screen').style.display='none';
  showHub();
}

// ‚îÄ‚îÄ‚îÄ STATS PANEL ‚îÄ‚îÄ‚îÄ
function openStats(){
  renderStats();
  document.getElementById('stats-panel').style.display='flex';
}
function closeStats(){
  document.getElementById('stats-panel').style.display='none';
}
function renderStats(){
  const gs=getGearStats();
  const content=document.getElementById('stats-content');
  let html='';
  
  html+=`<div class="stats-section"><h3>Character</h3>`;
  html+=`<div class="stat-row"><span class="stat-name">Level</span><span class="stat-value">${playerLevel}</span></div>`;
  html+=`<div class="stat-row"><span class="stat-name">XP</span><span class="stat-value">${playerXP} / ${xpToLevel(playerLevel)}</span></div>`;
  html+=`</div>`;
  
  html+=`<div class="stats-section"><h3>Combat Stats</h3>`;
  const atkBase=BASE_ATTACK_DMG+baseAtk;
  const atkGear=gs.ATK;
  html+=`<div class="stat-row"><span class="stat-name">ATK</span><span class="stat-value">${atkBase+atkGear}${atkGear?` <span class="stat-bonus">(+${atkGear})</span>`:''}</span></div>`;
  const defBase=baseDef;
  const defGear=gs.DEF;
  html+=`<div class="stat-row"><span class="stat-name">DEF</span><span class="stat-value">${defBase+defGear}${defGear?` <span class="stat-bonus">(+${defGear})</span>`:''}</span></div>`;
  const hpBase=baseMaxHp;
  const hpGear=gs.HP;
  html+=`<div class="stat-row"><span class="stat-name">HP</span><span class="stat-value">${hpBase+hpGear}${hpGear?` <span class="stat-bonus">(+${hpGear})</span>`:''}</span></div>`;
  const spdBase=160+baseSpeed;
  const spdGear=gs.Speed*10;
  html+=`<div class="stat-row"><span class="stat-name">Speed</span><span class="stat-value">${spdBase+spdGear}${spdGear?` <span class="stat-bonus">(+${spdGear})</span>`:''}</span></div>`;
  html+=`</div>`;
  
  html+=`<div class="stats-section"><h3>Lifetime</h3>`;
  html+=`<div class="stat-row"><span class="stat-name">Enemies Killed</span><span class="stat-value">${lifetimeKills}</span></div>`;
  html+=`<div class="stat-row"><span class="stat-name">Dungeons Cleared</span><span class="stat-value">${lifetimeDungeons}</span></div>`;
  html+=`<div class="stat-row"><span class="stat-name">Gold Earned</span><span class="stat-value">${lifetimeGold}</span></div>`;
  html+=`</div>`;
  
  content.innerHTML=html;
}

// ‚îÄ‚îÄ‚îÄ INVENTORY UI ‚îÄ‚îÄ‚îÄ
function openInventory(){
  renderInventory();
  document.getElementById('inventory-panel').style.display='flex';
}
function closeInventory(){
  document.getElementById('inventory-panel').style.display='none';
}

let longPressTimer=null;
function renderInventory(){
  const eqDiv=document.getElementById('equipped-slots');
  eqDiv.innerHTML='';
  ['weapon','armor','accessory'].forEach(slot=>{
    const item=equipped[slot];
    const el=document.createElement('div');
    el.className='inv-slot'+(item?' rarity-'+item.rarity:' empty');
    if(item){
      el.innerHTML=`<div class="item-icon">${item.icon}</div><div class="item-name" style="color:${item.rarityColor}">${item.name}</div>`;
      el.title=Object.entries(item.stats).map(([k,v])=>'+'+v+' '+k).join(', ');
      el.addEventListener('click',()=>{unequipItem(slot);renderInventory();});
      addLongPress(el,()=>{equipped[slot]=null;renderInventory();});
    }else{
      el.innerHTML=`<div class="item-icon">‚Äî</div><div class="item-name">${slot}</div>`;
    }
    eqDiv.appendChild(el);
  });
  const bpDiv=document.getElementById('backpack-slots');
  bpDiv.innerHTML='';
  for(let i=0;i<12;i++){
    const item=backpack[i];
    const el=document.createElement('div');
    el.className='inv-slot'+(item?' rarity-'+item.rarity:' empty');
    if(item){
      el.innerHTML=`<div class="item-icon">${item.icon}</div><div class="item-name" style="color:${item.rarityColor}">${item.name}</div>`;
      el.title=Object.entries(item.stats).map(([k,v])=>'+'+v+' '+k).join(', ');
      const idx=i;
      el.addEventListener('click',()=>{equipFromBackpack(idx);renderInventory();});
      addLongPress(el,()=>{backpack.splice(idx,1);renderInventory();});
    }else{
      el.innerHTML=`<div class="item-icon">¬∑</div>`;
    }
    bpDiv.appendChild(el);
  }
}

function addLongPress(el,cb){
  let timer;
  const start=()=>{timer=setTimeout(()=>{haptic('medium');cb();},600);};
  const cancel=()=>clearTimeout(timer);
  el.addEventListener('touchstart',start);
  el.addEventListener('touchend',cancel);
  el.addEventListener('touchcancel',cancel);
  el.addEventListener('mousedown',start);
  el.addEventListener('mouseup',cancel);
  el.addEventListener('mouseleave',cancel);
}

function equipFromBackpack(idx){
  const item=backpack[idx];
  if(!item)return;
  const slot=item.slot;
  const old=equipped[slot];
  equipped[slot]=item;
  backpack.splice(idx,1);
  if(old)backpack.push(old);
  updatePlayerFromGear();
}

function unequipItem(slot){
  const item=equipped[slot];
  if(!item)return;
  if(backpack.length>=12){showPickup('Backpack full!','#ef4444');return;}
  backpack.push(item);
  equipped[slot]=null;
  updatePlayerFromGear();
}

function updatePlayerFromGear(){
  if(player){
    player.maxHp=totalMaxHp();
    if(player.hp>player.maxHp)player.hp=player.maxHp;
    player.speed=totalSpeed();
  }
}

function addToInventory(gear){
  if(backpack.length<12){
    backpack.push(gear);
    return true;
  }
  showPickup('Backpack full!','#ef4444');
  return false;
}

// ‚îÄ‚îÄ‚îÄ ENEMIES ‚îÄ‚îÄ‚îÄ
const ENEMY_DEFS={
  slime:{r:12,hp:40,maxHp:40,speed:40,dmg:8,color:'#22c55e',eyeColor:'#fff',atkRange:28,atkCd:1.5,xp:10},
  skeleton:{r:13,hp:60,maxHp:60,speed:55,dmg:12,color:'#e2e8f0',eyeColor:'#1a1a2e',atkRange:32,atkCd:1.2,xp:20},
  archer:{r:12,hp:35,maxHp:35,speed:30,dmg:10,color:'#a78bfa',eyeColor:'#fff',atkRange:180,atkCd:2.0,xp:25,ranged:true},
  charger:{r:14,hp:40,maxHp:40,speed:50,dmg:20,color:'#ea580c',eyeColor:'#fff',atkRange:30,atkCd:3.0,xp:30,
    chargeState:'idle',chargeTelegraph:0,chargeDir:{x:0,y:0},chargeSpeed:0,stunTimer:0},
  wolf:{r:10,hp:20,maxHp:20,speed:65,dmg:8,color:'#9ca3af',eyeColor:'#fbbf24',atkRange:24,atkCd:1.2,xp:8,
    packId:null,packAngle:0},
  bomber:{r:11,hp:25,maxHp:25,speed:30,dmg:30,color:'#f97316',eyeColor:'#fff',atkRange:60,atkCd:99,xp:20,
    fuseTimer:-1,fuseMax:2.0},
  necromancer:{r:14,hp:60,maxHp:60,speed:35,dmg:5,color:'#7e22ce',eyeColor:'#a855f7',atkRange:40,atkCd:2.0,xp:50,
    summonTimer:5,summonCount:0,teleportCd:0,summonIds:[]},
  shield_knight:{r:15,hp:70,maxHp:70,speed:40,dmg:12,color:'#6b7280',eyeColor:'#fff',atkRange:34,atkCd:2.5,xp:35,
    shieldAngle:0,bashCd:0,bashTimer:4.0},
  boss:{r:28,hp:300,maxHp:300,speed:45,dmg:18,color:'#ef4444',eyeColor:'#fbbf24',atkRange:40,atkCd:1.0,xp:100},
};

let nextPackId=0;
function spawnEnemies(){
  enemies=[];
  const def=dungeonRooms[currentRoom];
  const hpMult=1+(dungeonDepth-1)*0.3;
  const dmgMult=1+(dungeonDepth-1)*0.15;
  def.enemies.forEach(e=>{
    if(e.type==='pack'){
      // Wolf pack spawn
      const packId=nextPackId++;
      const count=e.count||3;
      for(let i=0;i<count;i++){
        const base=ENEMY_DEFS.wolf;
        const angle=(Math.PI*2/count)*i;
        const ox=Math.cos(angle)*20, oy=Math.sin(angle)*20;
        enemies.push({...base,type:'wolf',
          x:e.x*TILE+TILE/2+ox, y:e.y*TILE+TILE/2+oy,
          hp:Math.ceil(base.hp*hpMult),maxHp:Math.ceil(base.maxHp*hpMult),
          dmg:Math.ceil(base.dmg*dmgMult),
          atkTimer:Math.random()*base.atkCd,hit:0,knockX:0,knockY:0,
          packId,packAngle:(Math.PI*2/count)*i});
      }
      return;
    }
    const base=ENEMY_DEFS[e.type];
    if(!base)return;
    const en={...base,type:e.type,
      x:e.x*TILE+TILE/2,y:e.y*TILE+TILE/2,
      hp:Math.ceil(base.hp*hpMult),maxHp:Math.ceil(base.maxHp*hpMult),
      dmg:Math.ceil(base.dmg*dmgMult),
      atkTimer:Math.random()*base.atkCd,hit:0,knockX:0,knockY:0};
    // Type-specific init
    if(e.type==='charger'){en.chargeState='idle';en.chargeTelegraph=0;en.chargeDir={x:0,y:0};en.chargeSpeed=0;en.stunTimer=0;}
    if(e.type==='bomber'){en.fuseTimer=-1;en.fuseMax=2.0;}
    if(e.type==='necromancer'){en.summonTimer=5;en.summonCount=0;en.teleportCd=0;en.summonIds=[];}
    if(e.type==='shield_knight'){en.shieldAngle=0;en.bashCd=0;en.bashTimer=4.0;}
    enemies.push(en);
  });
}

// ‚îÄ‚îÄ‚îÄ JOYSTICK ‚îÄ‚îÄ‚îÄ
function setupTouch(){
  const zone=document.getElementById('joystick-zone');
  zone.addEventListener('touchstart',e=>{e.preventDefault();if(joystickActive)return;const t=e.changedTouches[0];joystickTouchId=t.identifier;joystickActive=true;updateJoy(t);});
  zone.addEventListener('touchmove',e=>{e.preventDefault();for(const t of e.changedTouches)if(t.identifier===joystickTouchId)updateJoy(t);});
  const endJoy=e=>{for(const t of e.changedTouches)if(t.identifier===joystickTouchId){joystickActive=false;joystickTouchId=null;joyVec={x:0,y:0};resetThumb();}};
  zone.addEventListener('touchend',endJoy);
  zone.addEventListener('touchcancel',endJoy);
}

function updateJoy(t){
  const base=document.getElementById('joystick-base');
  const rect=base.getBoundingClientRect();
  const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
  let dx=t.clientX-cx,dy=t.clientY-cy;
  const dist=Math.sqrt(dx*dx+dy*dy);
  const maxR=rect.width/2;
  if(dist>maxR){dx=dx/dist*maxR;dy=dy/dist*maxR;}
  joyVec={x:dx/maxR,y:dy/maxR};
  const thumb=document.getElementById('joystick-thumb');
  thumb.style.left=(rect.width/2-25+dx)+'px';
  thumb.style.bottom=(rect.height/2-25-dy)+'px';
}
function resetThumb(){
  const base=document.getElementById('joystick-base');
  const thumb=document.getElementById('joystick-thumb');
  thumb.style.left=(base.offsetWidth/2-25)+'px';
  thumb.style.bottom=(base.offsetHeight/2-25)+'px';
}

// ‚îÄ‚îÄ‚îÄ ABILITIES ‚îÄ‚îÄ‚îÄ
function doAttack(){
  if(abilities.attack.cd>0||gameOver||gameDead||!gameStarted)return;
  abilities.attack.cd=ATTACK_CD;
  player.attackAnim=0.25;
  sfx('attack');haptic('light');
  const fx=player.facing.x,fy=player.facing.y;
  const dmg=totalAtk();
  const atkRange=getAttackRange();
  enemies.forEach(e=>{
    if(e.hp<=0)return;
    const dx=e.x-player.x,dy=e.y-player.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<atkRange+e.r){
      hitEnemy(e,dmg,dx/dist,dy/dist);
    }
  });
  // Slash particles scale with level
  const slashSize=20+playerLevel*1.5;
  for(let i=0;i<8;i++){
    const a=Math.atan2(fy,fx)+((Math.random()-0.5)*1.2);
    const sp=100+Math.random()*80;
    particles.push({x:player.x+fx*slashSize,y:player.y+fy*slashSize,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.3,maxLife:0.3,r:3+Math.random()*2+playerLevel*0.2,color:'#fbbf24'});
  }
}

function doDash(){
  if(abilities.dash.cd>0||gameOver||gameDead||!gameStarted)return;
  if(joyVec.x===0&&joyVec.y===0){player.dashDir={...player.facing};}
  else{const m=Math.sqrt(joyVec.x*joyVec.x+joyVec.y*joyVec.y);player.dashDir={x:joyVec.x/m,y:joyVec.y/m};}
  abilities.dash.cd=DASH_CD;
  player.dashing=true;
  sfx('dash');haptic('light');
  player.dashTimer=DASH_DUR;
  player.invincible=DASH_DUR+0.1;
  for(let i=0;i<6;i++){particles.push({x:player.x,y:player.y,vx:(Math.random()-0.5)*60,vy:(Math.random()-0.5)*60,life:0.4,maxLife:0.4,r:4,color:'#60a5fa'});}
}

function hitEnemy(e,dmg,nx,ny){
  // Shield knight frontal block check
  if(e.type==='shield_knight'){
    const hitAngle=Math.atan2(ny,nx);
    const shieldAngle=Math.atan2(player.y-e.y,player.x-e.x);
    let angleDiff=Math.abs(hitAngle-shieldAngle);
    if(angleDiff>Math.PI)angleDiff=Math.PI*2-angleDiff;
    if(angleDiff<Math.PI/2){
      // Frontal hit ‚Äî 75% damage reduction
      dmg=Math.ceil(dmg*0.25);
      sfx('shield_block');
      for(let i=0;i<4;i++){particles.push({x:e.x+nx*e.r,y:e.y+ny*e.r,vx:(Math.random()-0.5)*60,vy:(Math.random()-0.5)*60,life:0.3,maxLife:0.3,r:2,color:'#60a5fa'});}
    }
  }
  e.hp-=dmg;
  e.hit=0.15;
  sfx('hit');haptic('medium');
  e.knockX=nx*80;e.knockY=ny*80;
  shakeTimer=0.1;shakeIntensity=3;
  dmgNumbers.push({x:e.x,y:e.y-e.r,val:dmg,life:0.8,vy:-60,color:'#fbbf24'});
  for(let i=0;i<5;i++){particles.push({x:e.x,y:e.y,vx:nx*60+(Math.random()-0.5)*80,vy:ny*60+(Math.random()-0.5)*80,life:0.35,maxLife:0.35,r:2+Math.random()*3,color:e.color});}
  if(e.hp<=0){
    sfx('kill');haptic('kill');
    lifetimeKills++;
    // Unique death particles per enemy type
    const deathColor=e.type==='charger'?'#ea580c':e.type==='wolf'?'#6b7280':e.type==='bomber'?'#f97316':e.type==='necromancer'?'#a855f7':e.type==='shield_knight'?'#3b82f6':e.color;
    const deathCount=e.type==='necromancer'?18:e.type==='charger'?15:12;
    for(let i=0;i<deathCount;i++){const a=Math.random()*Math.PI*2;const sp=40+Math.random()*80;particles.push({x:e.x,y:e.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.6,maxLife:0.6,r:3+Math.random()*4,color:deathColor});}
    // Necromancer death: kill all summons
    if(e.type==='necromancer'){
      enemies.forEach(o=>{
        if(o._summonedBy===e&&o.hp>0){
          o.hp=0;
          for(let i=0;i<6;i++){const a=Math.random()*Math.PI*2;particles.push({x:o.x,y:o.y,vx:Math.cos(a)*50,vy:Math.sin(a)*50,life:0.4,maxLife:0.4,r:3,color:'#a855f7'});}
          gainXP(o.xp);
        }
      });
    }
    gainXP(e.xp);
    spawnLoot(e.x,e.y,e.type);
  }
}

function hitPlayer(dmg){
  if(player.invincible>0)return;
  const def=totalDef();
  const actualDmg=Math.max(1,dmg-def);
  player.hp-=actualDmg;
  player.invincible=0.5;
  sfx('hurt');haptic('heavy');
  shakeTimer=0.15;shakeIntensity=5;
  dmgNumbers.push({x:player.x,y:player.y-player.r,val:actualDmg,life:0.8,vy:-60,color:'#ef4444'});
  for(let i=0;i<4;i++){particles.push({x:player.x,y:player.y,vx:(Math.random()-0.5)*100,vy:(Math.random()-0.5)*100,life:0.3,maxLife:0.3,r:3,color:'#ef4444'});}
  if(player.hp<=0){player.hp=0;gameDead=true;sfx('die');haptic('die');setTimeout(()=>{document.getElementById('death-screen').style.display='flex';},500);}
}

// ‚îÄ‚îÄ‚îÄ COLLISION ‚îÄ‚îÄ‚îÄ
function tileAt(tx,ty){
  const room=rooms[currentRoom];
  if(tx<0||ty<0||tx>=ROOM_W||ty>=ROOM_H)return 1;
  return room[ty][tx];
}
function canMove(x,y,r){
  const margin=r;
  const corners=[[x-margin,y-margin],[x+margin,y-margin],[x-margin,y+margin],[x+margin,y+margin]];
  for(const[cx,cy]of corners){
    const tx=Math.floor(cx/TILE),ty=Math.floor(cy/TILE);
    if(tileAt(tx,ty)===1)return false;
  }
  return true;
}

// ‚îÄ‚îÄ‚îÄ ROOM TRANSITION ‚îÄ‚îÄ‚îÄ
function checkDoor(){
  const def=dungeonRooms[currentRoom];
  if(enemies.some(e=>e.hp>0))return;
  if(def.doors.includes('bottom')&&player.y>=(ROOM_H-2.5)*TILE){
    const doorX=7*TILE+TILE/2;
    if(Math.abs(player.x-doorX)<TILE*2) goToRoom(currentRoom+1,'top');
  }
  if(def.doors.includes('top')&&player.y<=TILE*2.5){
    const doorX=7*TILE+TILE/2;
    if(Math.abs(player.x-doorX)<TILE*2) goToRoom(currentRoom-1,'bottom');
  }
}

function goToRoom(idx,enterFrom){
  if(idx<0||idx>=dungeonRooms.length)return;
  roomTransition=0.4;roomTransAlpha=0;
  sfx('door');
  setTimeout(()=>{
    currentRoom=idx;
    lootDrops=[];
    spawnEnemies();
    if(enterFrom==='top')player.y=1.5*TILE;
    else player.y=(ROOM_H-1.5)*TILE;
    player.x=7*TILE+TILE/2;
    showRoomLabel(dungeonRooms[idx].name);
  },200);
}

function showRoomLabel(name){
  const el=document.getElementById('room-label');
  el.textContent=name;el.style.opacity='1';
  setTimeout(()=>{el.style.opacity='0';},2000);
}

// ‚îÄ‚îÄ‚îÄ PROJECTILES ‚îÄ‚îÄ‚îÄ
let projectiles=[];

// ‚îÄ‚îÄ‚îÄ UPDATE ‚îÄ‚îÄ‚îÄ
function update(dt){
  if(!gameStarted||gameOver||gameDead)return;
  
  // Slow-mo effect
  if(slowMoTimer>0){
    slowMoTimer-=dt;
    dt*=0.3; // 30% speed during level up
  }
  
  if(abilities.attack.cd>0)abilities.attack.cd=Math.max(0,abilities.attack.cd-dt);
  if(abilities.dash.cd>0)abilities.dash.cd=Math.max(0,abilities.dash.cd-dt);
  if(player.invincible>0)player.invincible-=dt;
  if(player.attackAnim>0)player.attackAnim-=dt;
  if(shakeTimer>0)shakeTimer-=dt;
  if(roomTransition>0){roomTransition-=dt;roomTransAlpha=roomTransition>0.2?1:roomTransition/0.2;}

  // Sparkle effect for full gear
  if(hasFullGear()){
    sparkleTimer+=dt;
    if(sparkleTimer>0.15){
      sparkleTimer=0;
      const a=Math.random()*Math.PI*2;
      const dist=getPlayerRadius()+4+Math.random()*8;
      sparkleParticles.push({
        x:player.x+Math.cos(a)*dist,
        y:player.y+Math.sin(a)*dist,
        life:0.6,maxLife:0.6,r:1+Math.random()*1.5
      });
    }
  }
  sparkleParticles.forEach(s=>{s.life-=dt;s.y-=15*dt;});
  sparkleParticles=sparkleParticles.filter(s=>s.life>0);

  // player movement
  player.speed=totalSpeed();
  if(player.dashing){
    player.dashTimer-=dt;
    const dashDist=getDashDist();
    const sp=dashDist/DASH_DUR;
    const nx=player.x+player.dashDir.x*sp*dt;
    const ny=player.y+player.dashDir.y*sp*dt;
    if(canMove(nx,ny,player.r)){player.x=nx;player.y=ny;}
    if(player.dashTimer<=0)player.dashing=false;
  }else{
    const mag=Math.sqrt(joyVec.x*joyVec.x+joyVec.y*joyVec.y);
    if(mag>0.1){
      const nx=player.x+joyVec.x*player.speed*dt;
      const ny=player.y+joyVec.y*player.speed*dt;
      if(canMove(nx,player.y,player.r))player.x=nx;
      if(canMove(player.x,ny,player.r))player.y=ny;
      player.facing={x:joyVec.x/mag,y:joyVec.y/mag};
    }
  }

  // enemies
  enemies.forEach(e=>{
    if(e.hp<=0)return;
    if(e.hit>0){e.hit-=dt;e.x+=e.knockX*dt*4;e.y+=e.knockY*dt*4;e.knockX*=0.9;e.knockY*=0.9;if(!canMove(e.x,e.y,e.r)){e.x-=e.knockX*dt*4;e.y-=e.knockY*dt*4;}return;}
    const dx=player.x-e.x,dy=player.y-e.y;
    const dist=Math.sqrt(dx*dx+dy*dy);

    // ‚îÄ‚îÄ‚îÄ CHARGER AI ‚îÄ‚îÄ‚îÄ
    if(e.type==='charger'){
      if(e.stunTimer>0){e.stunTimer-=dt;return;}
      if(e.chargeState==='idle'){
        // Wander slowly toward player
        if(dist>60){
          const nx=e.x+dx/dist*e.speed*0.5*dt;
          const ny=e.y+dy/dist*e.speed*0.5*dt;
          if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
        }
        e.atkTimer-=dt;
        if(e.atkTimer<=0&&dist<200){
          e.chargeState='telegraph';e.chargeTelegraph=0.8;
          e.chargeDir={x:dx/dist,y:dy/dist};
          e.atkTimer=e.atkCd;
        }
      }else if(e.chargeState==='telegraph'){
        e.chargeTelegraph-=dt;
        if(e.chargeTelegraph<=0){e.chargeState='charging';e.chargeSpeed=e.speed*3;e.chargeTimer=1.5;}
      }else if(e.chargeState==='charging'){
        e.chargeTimer-=dt;
        const nx=e.x+e.chargeDir.x*e.chargeSpeed*dt;
        const ny=e.y+e.chargeDir.y*e.chargeSpeed*dt;
        if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
        else{
          // Hit wall ‚Üí stunned
          e.chargeState='idle';e.stunTimer=1.5;
          sfx('charge_impact');haptic('heavy');shakeTimer=0.2;shakeIntensity=6;
          for(let i=0;i<10;i++){const a=Math.random()*Math.PI*2;particles.push({x:e.x,y:e.y,vx:Math.cos(a)*80,vy:Math.sin(a)*80,life:0.5,maxLife:0.5,r:3,color:'#fbbf24'});}
        }
        // Hit player while charging
        if(dist<e.r+player.r+5){hitPlayer(e.dmg);e.chargeState='idle';e.atkTimer=e.atkCd;}
        if(e.chargeTimer<=0)e.chargeState='idle';
      }
    }
    // ‚îÄ‚îÄ‚îÄ WOLF AI ‚îÄ‚îÄ‚îÄ
    else if(e.type==='wolf'){
      // Count alive pack members
      const packMates=enemies.filter(o=>o.hp>0&&o.type==='wolf'&&o.packId===e.packId);
      const packSize=packMates.length;
      const myIdx=packMates.indexOf(e);
      // Target angle around player
      const targetAngle=(Math.PI*2/packSize)*myIdx+Date.now()*0.001;
      const orbDist=50;
      const tx=player.x+Math.cos(targetAngle)*orbDist;
      const ty=player.y+Math.sin(targetAngle)*orbDist;
      const tdx=tx-e.x,tdy=ty-e.y;
      const tdist=Math.sqrt(tdx*tdx+tdy*tdy);
      if(tdist>5){
        const nx=e.x+tdx/tdist*e.speed*dt;
        const ny=e.y+tdy/tdist*e.speed*dt;
        if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
      }
      // Pack bonus: attack faster when 2+ wolves close
      const closeWolves=packMates.filter(w=>{ const d=Math.sqrt((player.x-w.x)**2+(player.y-w.y)**2);return d<50;}).length;
      const atkCdMod=closeWolves>=2?0.6:1.0;
      e.atkTimer-=dt;
      if(e.atkTimer<=0&&dist<e.atkRange+player.r){
        e.atkTimer=e.atkCd*atkCdMod;
        hitPlayer(e.dmg);
      }
    }
    // ‚îÄ‚îÄ‚îÄ BOMBER AI ‚îÄ‚îÄ‚îÄ
    else if(e.type==='bomber'){
      if(e.fuseTimer<0){
        // Walk toward player slowly
        if(dist>e.atkRange){
          const nx=e.x+dx/dist*e.speed*dt;
          const ny=e.y+dy/dist*e.speed*dt;
          if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
        }else{
          // Start countdown
          e.fuseTimer=e.fuseMax;
        }
      }else{
        e.fuseTimer-=dt;
        if(e.fuseTimer<=0){
          // EXPLODE
          sfx('explosion');haptic('heavy');shakeTimer=0.3;shakeIntensity=8;
          const expR=80;
          // Damage player
          if(dist<expR+player.r)hitPlayer(e.dmg);
          // Damage other enemies
          enemies.forEach(o=>{
            if(o===e||o.hp<=0)return;
            const od=Math.sqrt((o.x-e.x)**2+(o.y-e.y)**2);
            if(od<expR+o.r){
              const ndx=(o.x-e.x)/(od||1), ndy=(o.y-e.y)/(od||1);
              hitEnemy(o,e.dmg,ndx,ndy);
            }
          });
          // Explosion particles
          for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2;const sp=60+Math.random()*120;
            particles.push({x:e.x,y:e.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:0.6,maxLife:0.6,r:4+Math.random()*5,color:['#f97316','#ef4444','#fbbf24'][Math.floor(Math.random()*3)]});}
          e.hp=0; // Die
          gainXP(e.xp);spawnLoot(e.x,e.y,e.type);
        }
      }
    }
    // ‚îÄ‚îÄ‚îÄ NECROMANCER AI ‚îÄ‚îÄ‚îÄ
    else if(e.type==='necromancer'){
      // Flee if player too close
      if(e.teleportCd>0)e.teleportCd-=dt;
      if(dist<80&&e.teleportCd<=0){
        // Teleport away
        let nx,ny,attempts=0;
        do{nx=2*TILE+Math.random()*11*TILE;ny=3*TILE+Math.random()*14*TILE;attempts++;}
        while((!canMove(nx,ny,e.r)||Math.sqrt((player.x-nx)**2+(player.y-ny)**2)<120)&&attempts<20);
        e.x=nx;e.y=ny;e.teleportCd=3;
        for(let i=0;i<8;i++){particles.push({x:e.x,y:e.y,vx:(Math.random()-0.5)*80,vy:(Math.random()-0.5)*80,life:0.5,maxLife:0.5,r:3,color:'#a855f7'});}
      }else if(dist<150){
        // Move away
        const nx=e.x-dx/dist*e.speed*dt;const ny=e.y-dy/dist*e.speed*dt;
        if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
      }
      // Summon skeletons
      e.summonTimer-=dt;
      // Clean dead summons
      e.summonIds=e.summonIds.filter(id=>enemies.some(o=>o._summonId===id&&o.hp>0));
      if(e.summonTimer<=0&&e.summonIds.length<3){
        e.summonTimer=5;
        sfx('summon');
        const count=1+Math.floor(Math.random()*2);
        for(let i=0;i<count&&e.summonIds.length<3;i++){
          const base=ENEMY_DEFS.skeleton;
          const sa=Math.random()*Math.PI*2;
          const sid=Math.random().toString(36).substr(2,6);
          const summon={...base,type:'skeleton',
            x:e.x+Math.cos(sa)*30,y:e.y+Math.sin(sa)*30,
            hp:Math.ceil(base.hp*0.5),maxHp:Math.ceil(base.maxHp*0.5),
            dmg:base.dmg,atkTimer:Math.random()*base.atkCd,hit:0,knockX:0,knockY:0,
            _summonId:sid,_summonedBy:e};
          enemies.push(summon);
          e.summonIds.push(sid);
          // Purple summon particles
          for(let j=0;j<8;j++){particles.push({x:summon.x,y:summon.y,vx:(Math.random()-0.5)*60,vy:(Math.random()-0.5)*60,life:0.5,maxLife:0.5,r:3,color:'#a855f7'});}
        }
      }
      // Weak direct attack
      e.atkTimer-=dt;
      if(e.atkTimer<=0&&dist<e.atkRange+player.r){e.atkTimer=e.atkCd;hitPlayer(e.dmg);}
    }
    // ‚îÄ‚îÄ‚îÄ SHIELD KNIGHT AI ‚îÄ‚îÄ‚îÄ
    else if(e.type==='shield_knight'){
      e.shieldAngle=Math.atan2(dy,dx);
      // Move toward player
      if(dist>e.atkRange){
        const nx=e.x+dx/dist*e.speed*dt;const ny=e.y+dy/dist*e.speed*dt;
        if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
      }
      // Regular attack
      e.atkTimer-=dt;
      if(e.atkTimer<=0&&dist<e.atkRange+player.r){e.atkTimer=e.atkCd;hitPlayer(e.dmg);}
      // Shield bash
      e.bashTimer-=dt;
      if(e.bashTimer<=0&&dist<e.atkRange+player.r+10){
        e.bashTimer=4.0;
        sfx('shield_block');haptic('medium');
        // Knockback player
        const kx=dx/dist*100,ky=dy/dist*100;
        const pnx=player.x+kx*0.3,pny=player.y+ky*0.3;
        if(canMove(pnx,pny,player.r)){player.x=pnx;player.y=pny;}
        hitPlayer(Math.ceil(e.dmg*0.5));
        for(let i=0;i<6;i++){particles.push({x:e.x+dx/dist*e.r,y:e.y+dy/dist*e.r,vx:dx/dist*40+(Math.random()-0.5)*40,vy:dy/dist*40+(Math.random()-0.5)*40,life:0.3,maxLife:0.3,r:3,color:'#60a5fa'});}
      }
    }
    // ‚îÄ‚îÄ‚îÄ RANGED (archer) ‚îÄ‚îÄ‚îÄ
    else if(e.ranged){
      if(dist<120){const nx=e.x-dx/dist*e.speed*dt;const ny=e.y-dy/dist*e.speed*dt;if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}}
      e.atkTimer-=dt;
      if(e.atkTimer<=0&&dist<e.atkRange){
        e.atkTimer=e.atkCd;
        projectiles.push({x:e.x,y:e.y,vx:dx/dist*200,vy:dy/dist*200,r:4,dmg:e.dmg,life:2,color:'#c084fc'});
      }
    }
    // ‚îÄ‚îÄ‚îÄ DEFAULT MELEE (slime, skeleton, boss) ‚îÄ‚îÄ‚îÄ
    else{
      if(dist>e.atkRange){
        const nx=e.x+dx/dist*e.speed*dt;
        const ny=e.y+dy/dist*e.speed*dt;
        if(canMove(nx,ny,e.r)){e.x=nx;e.y=ny;}
      }
      e.atkTimer-=dt;
      if(e.atkTimer<=0&&dist<e.atkRange+player.r){
        e.atkTimer=e.atkCd;
        hitPlayer(e.dmg);
      }
    }

    if(e.type==='boss'&&e.hp<e.maxHp*0.5&&Math.random()<0.01){
      for(let i=0;i<8;i++){
        const a=i*Math.PI/4;
        projectiles.push({x:e.x,y:e.y,vx:Math.cos(a)*120,vy:Math.sin(a)*120,r:5,dmg:10,life:2.5,color:'#f97316'});
      }
    }
  });

  // projectiles
  projectiles.forEach(p=>{
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
    const dx=p.x-player.x,dy=p.y-player.y;
    if(Math.sqrt(dx*dx+dy*dy)<player.r+p.r){hitPlayer(p.dmg);p.life=0;}
    const tx=Math.floor(p.x/TILE),ty=Math.floor(p.y/TILE);
    if(tileAt(tx,ty)===1)p.life=0;
  });
  projectiles=projectiles.filter(p=>p.life>0);

  // loot pickup
  lootDrops.forEach(l=>{
    l.glow+=dt;
    const dx=player.x-l.x,dy=player.y-l.y;
    if(Math.sqrt(dx*dx+dy*dy)<player.r+14){
      if(l.type==='gold'){
        gold+=l.amount;
        lifetimeGold+=l.amount;
        showPickup('+ '+l.amount+' Gold','#fbbf24');
        sfx('pickup');
      }else if(l.type==='gear'){
        if(addToInventory(l.gear)){
          showPickup('+1 '+l.gear.name,l.gear.rarityColor);
          sfx('pickup');
        }
      }
      l.picked=true;
    }
  });
  lootDrops=lootDrops.filter(l=>!l.picked);

  // particles
  particles.forEach(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;p.vx*=0.95;p.vy*=0.95;});
  particles=particles.filter(p=>p.life>0);
  dmgNumbers.forEach(d=>{d.y+=d.vy*dt;d.life-=dt;});
  dmgNumbers=dmgNumbers.filter(d=>d.life>0);

  // camera
  const roomPxW=ROOM_W*TILE, roomPxH=ROOM_H*TILE;
  let targetX=player.x-W/2;
  let targetY=player.y-H/2;
  if(roomPxW>W){targetX=Math.max(0,Math.min(targetX,roomPxW-W));}
  else{targetX=(roomPxW-W)/2;}
  if(roomPxH>H){targetY=Math.max(0,Math.min(targetY,roomPxH-H));}
  else{targetY=(roomPxH-H)/2;}
  camera.x+=(targetX-camera.x)*0.08;
  camera.y+=(targetY-camera.y)*0.08;

  checkDoor();

  // boss dead ‚Üí dungeon complete
  if(dungeonRooms[currentRoom].isBoss&&enemies.every(e=>e.hp<=0)&&!gameOver){
    gameOver=true;sfx('win');haptic('win');
    lifetimeDungeons++;
    dungeonDepth++;
    document.getElementById('complete-text').textContent='Run '+(dungeonDepth-1)+' cleared!';
    setTimeout(()=>{document.getElementById('screen-overlay').style.display='flex';},1000);
  }

  // UI updates
  player.maxHp=totalMaxHp();
  const fill=document.getElementById('health-bar-fill');
  fill.style.width=(player.hp/player.maxHp*100)+'%';
  fill.style.background=player.hp>player.maxHp*0.5?'linear-gradient(180deg,#4ade80,#22c55e)':player.hp>player.maxHp*0.25?'linear-gradient(180deg,#fbbf24,#f59e0b)':'linear-gradient(180deg,#ef4444,#dc2626)';
  document.getElementById('health-text').textContent=Math.ceil(player.hp)+' / '+player.maxHp;
  document.getElementById('level-label').textContent='Lv '+playerLevel;
  document.getElementById('xp-bar-fill').style.width=(playerXP/xpToLevel(playerLevel)*100)+'%';
  document.getElementById('gold-display').textContent='üí∞ '+gold;

  updateAbilityUI('btn-attack',abilities.attack);
  updateAbilityUI('btn-dash',abilities.dash);
}

function updateAbilityUI(id,ab){
  const btn=document.getElementById(id);
  const overlay=btn.querySelector('.cd-overlay');
  const text=btn.querySelector('.cd-text');
  if(ab.cd>0){
    const pct=ab.cd/ab.maxCd;
    const deg=pct*360;
    overlay.style.clipPath=`polygon(50% 50%, 50% 0%, ${deg>90?'100% 0%,':''}${deg>180?'100% 100%,':''}${deg>270?'0% 100%,':''}${cdEdge(deg)})`;
    overlay.style.display='block';
    text.textContent=ab.cd.toFixed(1);
    btn.style.opacity='0.7';
  }else{
    overlay.style.display='none';
    text.textContent='';
    btn.style.opacity='1';
  }
}
function cdEdge(deg){
  if(deg<=90)return(50+50*Math.tan(deg*Math.PI/180))+'% 0%';
  if(deg<=180)return'100% '+(50+50*Math.tan((deg-90)*Math.PI/180))+'%';
  if(deg<=270)return(50-50*Math.tan((deg-180)*Math.PI/180))+'% 100%';
  return'0% '+(50-50*Math.tan((deg-270)*Math.PI/180))+'%';
}

// ‚îÄ‚îÄ‚îÄ DRAW ‚îÄ‚îÄ‚îÄ
function draw(){
  ctx.fillStyle='#1a1a2e';
  ctx.fillRect(0,0,W+10,H+10);
  if(!gameStarted)return;

  ctx.save();
  let sx=0,sy=0;
  if(shakeTimer>0){sx=(Math.random()-0.5)*shakeIntensity*2;sy=(Math.random()-0.5)*shakeIntensity*2;}
  ctx.translate(-camera.x+sx,-camera.y+sy);

  // tiles
  const room=rooms[currentRoom];
  for(let y=0;y<ROOM_H;y++)for(let x=0;x<ROOM_W;x++){
    const t=room[y][x];
    const px=x*TILE,py=y*TILE;
    if(t===1){
      ctx.fillStyle='#1a1a2e';ctx.fillRect(px,py,TILE,TILE);
      ctx.fillStyle='#252540';ctx.fillRect(px+1,py+1,TILE-2,TILE-2);
    }else if(t===2){
      const cleared=enemies.every(e=>e.hp<=0);
      ctx.fillStyle=cleared?'#065f46':'#7f1d1d';
      ctx.fillRect(px,py,TILE,TILE);
      if(cleared){ctx.fillStyle='#10b981';ctx.fillRect(px+8,py+2,TILE-16,TILE-4);}
    }else{
      ctx.fillStyle=(x+y)%2===0?'#2d3a4a':'#263242';
      ctx.fillRect(px,py,TILE,TILE);
      ctx.strokeStyle='rgba(255,255,255,0.04)';ctx.strokeRect(px,py,TILE,TILE);
    }
  }

  // loot drops
  lootDrops.forEach(l=>{
    ctx.save();
    ctx.translate(l.x,l.y);
    const pulse=0.8+Math.sin(l.glow*4)*0.2;
    ctx.globalAlpha=0.3+Math.sin(l.glow*3)*0.15;
    ctx.fillStyle=l.type==='gold'?'#fbbf24':l.gear.rarityColor;
    ctx.beginPath();ctx.arc(0,0,14*pulse,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
    ctx.font='16px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(l.icon,0,0);
    ctx.restore();
  });

  // enemies
  enemies.forEach(e=>{
    if(e.hp<=0)return;
    ctx.save();
    ctx.translate(e.x,e.y);
    if(e.hit>0)ctx.globalAlpha=0.5+Math.sin(e.hit*40)*0.5;

    if(e.type==='boss'){
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.arc(0,0,e.r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#991b1b';ctx.beginPath();ctx.arc(0,0,e.r-4,0,Math.PI*2);ctx.fill();
      ctx.fillStyle=e.color;ctx.beginPath();ctx.arc(0,0,e.r-8,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#fbbf24';
      ctx.fillRect(-12,-e.r-8,24,8);
      ctx.beginPath();ctx.moveTo(-12,-e.r-8);ctx.lineTo(-8,-e.r-16);ctx.lineTo(-4,-e.r-8);ctx.fill();
      ctx.beginPath();ctx.moveTo(-4,-e.r-8);ctx.lineTo(0,-e.r-16);ctx.lineTo(4,-e.r-8);ctx.fill();
      ctx.beginPath();ctx.moveTo(4,-e.r-8);ctx.lineTo(8,-e.r-16);ctx.lineTo(12,-e.r-8);ctx.fill();
    }else if(e.type==='slime'){
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.ellipse(0,2,e.r,e.r*0.8,0,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#16a34a';
      ctx.beginPath();ctx.ellipse(0,4,e.r*0.7,e.r*0.5,0,0,Math.PI*2);ctx.fill();
    }else if(e.type==='skeleton'){
      ctx.fillStyle=e.color;
      ctx.fillRect(-e.r,-e.r,e.r*2,e.r*2);
      ctx.fillStyle='#94a3b8';
      ctx.fillRect(-e.r+2,-e.r+2,e.r*2-4,e.r*2-4);
    }else if(e.type==='archer'){
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.moveTo(0,-e.r);ctx.lineTo(e.r,e.r);ctx.lineTo(-e.r,e.r);ctx.closePath();ctx.fill();
    }else if(e.type==='charger'){
      // Red-orange rectangle wider than tall with horns
      const shake=(e.chargeState==='telegraph')?(Math.random()-0.5)*4:0;
      ctx.translate(shake,0);
      if(e.chargeState==='telegraph'){
        // Red glow telegraph
        ctx.fillStyle='rgba(239,68,68,'+((0.3+Math.sin(Date.now()*0.02)*0.3))+')';
        ctx.beginPath();ctx.arc(0,0,e.r+8,0,Math.PI*2);ctx.fill();
      }
      ctx.fillStyle=e.chargeState==='charging'?'#dc2626':e.color;
      ctx.fillRect(-e.r-4,-e.r+2,e.r*2+8,e.r*2-4);
      // Horns
      ctx.fillStyle='#fbbf24';
      ctx.beginPath();ctx.moveTo(-e.r+2,-e.r+2);ctx.lineTo(-e.r,-e.r-8);ctx.lineTo(-e.r+6,-e.r+2);ctx.fill();
      ctx.beginPath();ctx.moveTo(e.r-6,-e.r+2);ctx.lineTo(e.r,-e.r-8);ctx.lineTo(e.r-2,-e.r+2);ctx.fill();
      // Stunned stars
      if(e.stunTimer>0){
        for(let i=0;i<3;i++){
          const sa=Date.now()*0.005+i*2.1;
          const sx=Math.cos(sa)*12,sy=-e.r-12+Math.sin(sa*2)*3;
          ctx.fillStyle='#fbbf24';ctx.font='10px system-ui';ctx.textAlign='center';
          ctx.fillText('‚≠ê',sx,sy);
        }
      }
    }else if(e.type==='wolf'){
      // Small gray circle
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.arc(0,0,e.r,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#6b7280';
      ctx.beginPath();ctx.arc(0,1,e.r-2,0,Math.PI*2);ctx.fill();
      // Pointy ears
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.moveTo(-6,-e.r+1);ctx.lineTo(-4,-e.r-5);ctx.lineTo(-2,-e.r+1);ctx.fill();
      ctx.beginPath();ctx.moveTo(2,-e.r+1);ctx.lineTo(4,-e.r-5);ctx.lineTo(6,-e.r+1);ctx.fill();
    }else if(e.type==='bomber'){
      // Orange circle with fuse; pulse during countdown
      let scale=1;
      if(e.fuseTimer>=0){
        const frac=1-e.fuseTimer/e.fuseMax;
        scale=1+frac*0.3;
        const pulseSpeed=5+frac*20;
        ctx.fillStyle=Math.sin(Date.now()*0.001*pulseSpeed)>0?'#ef4444':e.color;
      }else{
        ctx.fillStyle=e.color;
      }
      ctx.beginPath();ctx.arc(0,0,e.r*scale,0,Math.PI*2);ctx.fill();
      ctx.fillStyle='#c2410c';
      ctx.beginPath();ctx.arc(0,1,e.r*scale-3,0,Math.PI*2);ctx.fill();
      // Fuse on top
      ctx.strokeStyle='#854d0e';ctx.lineWidth=2;
      ctx.beginPath();ctx.moveTo(0,-e.r*scale);ctx.lineTo(2,-e.r*scale-6);ctx.stroke();
      // Fuse spark
      ctx.fillStyle=['#fbbf24','#ef4444','#fff'][Math.floor(Math.random()*3)];
      ctx.beginPath();ctx.arc(2+Math.random()*2,-e.r*scale-6+Math.random()*2,2,0,Math.PI*2);ctx.fill();
    }else if(e.type==='necromancer'){
      // Dark purple diamond with hood
      ctx.fillStyle=e.color;
      ctx.beginPath();ctx.moveTo(0,-e.r);ctx.lineTo(e.r,0);ctx.lineTo(0,e.r);ctx.lineTo(-e.r,0);ctx.closePath();ctx.fill();
      // Hood (triangle on top)
      ctx.fillStyle='#581c87';
      ctx.beginPath();ctx.moveTo(-8,-e.r+4);ctx.lineTo(0,-e.r-8);ctx.lineTo(8,-e.r+4);ctx.closePath();ctx.fill();
      // Summoning glow
      if(e.summonTimer<1){
        ctx.globalAlpha=0.4+Math.sin(Date.now()*0.01)*0.2;
        ctx.fillStyle='#a855f7';
        ctx.beginPath();ctx.arc(0,0,e.r+10,0,Math.PI*2);ctx.fill();
        ctx.globalAlpha=1;
      }
    }else if(e.type==='shield_knight'){
      // Gray square body
      ctx.fillStyle=e.color;
      ctx.fillRect(-e.r,-e.r,e.r*2,e.r*2);
      ctx.fillStyle='#4b5563';
      ctx.fillRect(-e.r+2,-e.r+2,e.r*2-4,e.r*2-4);
      // Shield (blue square facing player)
      const sa=e.shieldAngle||0;
      ctx.save();
      ctx.rotate(sa);
      ctx.fillStyle='#3b82f6';
      ctx.fillRect(e.r-4,-8,6,16);
      ctx.fillStyle='#60a5fa';
      ctx.fillRect(e.r-3,-6,4,12);
      ctx.restore();
    }

    // Eyes (shared for all types)
    const edx=player.x-e.x,edy=player.y-e.y,da=Math.atan2(edy,edx);
    ctx.fillStyle=e.eyeColor;
    const eex=Math.cos(da)*3,eey=Math.sin(da)*3;
    ctx.beginPath();ctx.arc(-4+eex,-3+eey,2.5,0,Math.PI*2);ctx.fill();
    ctx.beginPath();ctx.arc(4+eex,-3+eey,2.5,0,Math.PI*2);ctx.fill();
    // HP bar
    if(e.hp<e.maxHp){
      ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(-e.r,-e.r-8,e.r*2,5);
      ctx.fillStyle='#ef4444';ctx.fillRect(-e.r,-e.r-8,e.r*2*(e.hp/e.maxHp),5);
    }
    ctx.restore();
  });

  // projectiles
  projectiles.forEach(p=>{
    ctx.fillStyle=p.color;ctx.globalAlpha=0.8;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    ctx.globalAlpha=1;
  });

  // player
  ctx.save();
  ctx.translate(player.x,player.y);
  if(player.invincible>0)ctx.globalAlpha=0.4+Math.sin(player.invincible*30)*0.3;
  
  const colors=getPlayerColor();
  const pr=getPlayerRadius();
  const glowI=getGlowIntensity();
  
  // Glow ring (level-based)
  if(glowI>0.05){
    const gradient=ctx.createRadialGradient(0,0,pr,0,0,pr+8+glowI*12);
    gradient.addColorStop(0,`rgba(251,191,36,${glowI*0.4})`);
    gradient.addColorStop(1,'rgba(251,191,36,0)');
    ctx.fillStyle=gradient;
    ctx.beginPath();ctx.arc(0,0,pr+8+glowI*12,0,Math.PI*2);ctx.fill();
  }
  
  // Shadow
  ctx.fillStyle='rgba(0,0,0,0.3)';ctx.beginPath();ctx.ellipse(0,pr-2,pr,pr*0.4,0,0,Math.PI*2);ctx.fill();
  
  // Body with level-based color
  ctx.fillStyle=colors.main;ctx.beginPath();ctx.arc(0,0,pr,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=colors.mid;ctx.beginPath();ctx.arc(0,2,pr-3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle=colors.main;ctx.beginPath();ctx.arc(0,-1,pr-5,0,Math.PI*2);ctx.fill();
  
  // Eyes
  const fa=Math.atan2(player.facing.y,player.facing.x);
  const pex=Math.cos(fa)*4,pey=Math.sin(fa)*4;
  ctx.fillStyle='#fff';
  ctx.beginPath();ctx.arc(-4+pex,-2+pey,3.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(4+pex,-2+pey,3.5,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#1e293b';
  ctx.beginPath();ctx.arc(-4+pex*1.3,-2+pey*1.3,1.5,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(4+pex*1.3,-2+pey*1.3,1.5,0,Math.PI*2);ctx.fill();
  
  // Attack animation (scales with level)
  if(player.attackAnim>0){
    const atkRange=getAttackRange();
    const slashR=22+playerLevel*1.5;
    ctx.strokeStyle='rgba(251,191,36,0.6)';ctx.lineWidth=3+playerLevel*0.2;
    ctx.beginPath();ctx.arc(player.facing.x*(atkRange*0.4),player.facing.y*(atkRange*0.4),slashR,fa-1,fa+1);ctx.stroke();
  }
  
  ctx.restore();
  
  // Equipped weapon icons floating near player
  const gearIcons=[];
  if(equipped.weapon) gearIcons.push(equipped.weapon.icon);
  if(equipped.armor) gearIcons.push(equipped.armor.icon);
  if(equipped.accessory) gearIcons.push(equipped.accessory.icon);
  if(gearIcons.length>0){
    const now=Date.now()*0.002;
    gearIcons.forEach((icon,i)=>{
      const angle=now+i*(Math.PI*2/gearIcons.length);
      const gx=player.x+Math.cos(angle)*(pr+14);
      const gy=player.y+Math.sin(angle)*(pr+14);
      ctx.font='10px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.globalAlpha=0.7;
      ctx.fillText(icon,gx,gy);
      ctx.globalAlpha=1;
    });
  }
  
  // Full gear sparkle particles
  sparkleParticles.forEach(s=>{
    ctx.globalAlpha=(s.life/s.maxLife)*0.8;
    ctx.fillStyle='#fbbf24';
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.fill();
  });
  ctx.globalAlpha=1;

  // particles
  particles.forEach(p=>{
    ctx.globalAlpha=p.life/p.maxLife;ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*(p.life/p.maxLife),0,Math.PI*2);ctx.fill();
  });
  ctx.globalAlpha=1;

  // dmg numbers
  dmgNumbers.forEach(d=>{
    ctx.globalAlpha=d.life/0.8;
    ctx.fillStyle=d.color;ctx.font='bold 16px system-ui';ctx.textAlign='center';
    ctx.fillText('-'+d.val,d.x,d.y);
  });
  ctx.globalAlpha=1;

  ctx.restore();

  // room transition overlay
  if(roomTransition>0){
    ctx.fillStyle=`rgba(0,0,0,${roomTransAlpha})`;
    ctx.fillRect(0,0,W,H);
  }

  drawMinimap();
}

function drawMinimap(){
  const mc=minimapCtx;
  mc.clearRect(0,0,80,80);
  mc.fillStyle='rgba(0,0,0,0.5)';
  mc.fillRect(0,0,80,80);
  const totalRooms=dungeonRooms.length;
  const roomH=12,roomW=16,gap=4;
  const startY=(80-(totalRooms*(roomH+gap)-gap))/2;
  for(let i=0;i<totalRooms;i++){
    const rx=(80-roomW)/2,ry=startY+i*(roomH+gap);
    mc.fillStyle=i===currentRoom?'#3b82f6':'#475569';
    if(i<currentRoom)mc.fillStyle='#22c55e';
    mc.fillRect(rx,ry,roomW,roomH);
    if(i===currentRoom){mc.fillStyle='#fbbf24';mc.fillRect(rx+6,ry+3,4,6);}
    if(dungeonRooms[i].isBoss){mc.fillStyle='#ef4444';mc.fillRect(rx+2,ry+2,3,3);}
  }
}

// ‚îÄ‚îÄ‚îÄ LOOP ‚îÄ‚îÄ‚îÄ
function loop(t){
  const dt=Math.min((t-lastTime)/1000,0.05);
  lastTime=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

window.addEventListener('load',init);
</script>
</body>
</html>
